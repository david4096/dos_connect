#!/bin/bash
# start VMs
# you should have docker & docker compose already setup
docker-compose --version >> /dev/null
if [ $? -ne 0 ]; then
  echo "you should have docker & docker compose already setup FAIL"; exit 1
fi


# initialize our host volumes
mkdir -p volumes/jars
mkdir -p volumes/files
mkdir -p volumes/elastic/backups

echo "## checking for successful build of our connectors ..."
if [ -e "volumes/jars/connect-directory-source-1.0-all.jar" ]; then
  echo "connect-directory-source-1.0-all.jar OK"
else
  ( bin/build-connectors )
fi

echo "## create docker compose images..."
docker-compose create 
echo "## start docker compose images for zookeeper kafka..."
docker-compose start zookeeper kafka

echo "## wait for kafka to start up..."
until $(docker-compose logs kafka | grep started > /dev/null); do
    printf '.'
    sleep 5
done
echo "kafka up OK"


echo "## create s3-topic ..."
bin/purge s3-topic


echo "## start remainder of containers ...."
docker-compose start  
