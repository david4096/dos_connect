#!/bin/bash
# create an image to build kafka connectors
echo "## checking for connector build image..."
[ ! -z $(docker images -q kafka-connector-builder:latest) ] || docker build -t kafka-connector-builder -f kafka-connector-builder.dockerfile .
if [ -z $(docker images -q kafka-connector-builder:latest) ]; then
  echo "builder does not exist FAIL"; exit 1
fi
echo "builder exists OK"

docker inspect  --format="{{.State.Running}}" builder > /dev/null
if [ $? -ne 0 ]; then
  echo "## Starting builder..."
  docker run --name builder -v $(pwd)/volumes/jars:/jars -d -t kafka-connector-builder bash
fi
docker inspect  --format="{{.State.Running}}" builder > /dev/null
if [ $? -ne 0 ]; then
  echo "builder not running FAIL"; exit 1
fi
echo "builder running OK"

echo "## building connectors ..."
rm -f volumes/jars/connect-directory-source-1.0-all.jar
# the build step already built the connector we want to use
# so copy that target to our volume
docker exec builder bash -c "git pull origin s3; gradle shadowJar; cp build/libs/connect-directory-source-1.0-all.jar  /jars"
#
# # check all ok

echo "## checking for successful build of our connector DirectorySourceConnector..."
if [ -e "volumes/jars/connect-directory-source-1.0-all.jar" ]; then
  echo "connect-directory-source-1.0-all.jar OK"
else
  echo "connect-directory-source-1.0-all.jar FAIL"
  exit 1
fi
