#!/bin/bash
echo "## checking jdbc-sink worker in kafka worker config..."
curl --silent --fail  localhost:28082/connectors/jdbc-sink/status  > /dev/null
if [ $? -eq 0 ]; then
  echo "jdbc-sink found OK"
else
  echo "### jdbc-sink not found creating it..."
  echo "### will read directory entries of from topic 'directory-topic' and write to jdbc tables..."
  curl --silent -X POST -H "Content-Type: application/json" --data \
  '{
  "name":"jdbc-sink",
  "config":{
    "connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector",
    "tasks.max":"1",
    "topics":"directory-topic",
    "connection.url":"jdbc:sqlite:/files/test.db",
    "auto.create": true,
    "auto.evolve": true,
    "key.converter": "org.apache.kafka.connect.storage.StringConverter",
    "value.converter": "org.apache.kafka.connect.json.JsonConverter",
    "internal.key.converter": "org.apache.kafka.connect.json.JsonConverter",
    "internal.value.converter": "org.apache.kafka.connect.json.JsonConverter"
  }
  }' \
  http://localhost:28082/connectors > /dev/null
  printf '.'
  sleep 10
  curl --fail --silent  localhost:28082/connectors/jdbc-sink/status  > /dev/null
  if [ $? -eq 0 ]; then
    echo "jdbc-sink found OK"
  else
    echo "jdbc-sink could not be created FAIL"
    exit 1
  fi
fi

echo '## list directory elements from jdbc...'
sleep 10
echo .tables | sqlite3  volumes/files/test.db
